{# templates/finance/cashflow/report_grouped.html.twig #}
{% extends 'base.html.twig' %}
{% block title %}ДДС — по месяцам (версия из ТЗ){% endblock %}
{% macro render_node(name, node, level, months, categoryDirections) %}
    {% set is_expense = (categoryDirections[name]|default('income')) == 'expense' %}
    <tr class="{{ level == 1 ? 'fw-bold' : '' }}">
        <td class="ps-{{ (level - 1) * 2 }}">{{ name }}</td>
        {% for month in months %}
            {% set value = node.__total[month]|default(0) %}
            <td class="text-end {{ is_expense ? 'text-danger' : '' }}">
                {{ is_expense and value != 0 ? '-' : '' }}{{ value|number_format(0, '.', ' ') }}
            </td>
        {% endfor %}
    </tr>
    {% if level < 4 %}
        {% for childName, childNode in node.__children %}
            {{ _self.render_node(childName, childNode, level + 1, months, categoryDirections) }}
        {% endfor %}
    {% endif %}
{% endmacro %}
{% block body %}
    <div class="container-xl">
        <div class="page-header mb-3">
            <h2>Отчёт ДДС (по строкам)</h2>
        </div>

        <div class="table-responsive">
            <table class="table table-bordered table-striped">
                <thead class="thead-light">
                <tr>
                    <th>Категория</th>
                    {% for month in months %}
                        <th class="text-center">{{ month|date('F Y') }}</th>
                    {% endfor %}
                </tr>
                </thead>
                <tbody>
                <tr class="fw-bold bg-light">
                    <td>Остаток на начало</td>
                    {% for month in months %}
                        <td class="text-end">{{ monthly[month].start|number_format(0, '.', ' ') }} ₽</td>
                    {% endfor %}
                </tr>





                {% import _self as macros %}
                {% for root in rootCategories %}
                    {% set name = root.name %}
                    {% if report[name] is defined %}
                        {{ macros.render_node(name, report[name], 1, months, categoryDirections) }}
                    {% endif %}
                {% endfor %}
                <tr class="fw-bold bg-light">
                    <td>Остаток на конец</td>
                    {% for month in months %}
                        <td class="text-end">{{ monthly[month].end|number_format(0, '.', ' ') }} ₽</td>
                    {% endfor %}
                </tr>
                </tbody>

            </table>
        </div>
    </div>
{% endblock %}

